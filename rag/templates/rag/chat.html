{% extends "rag/base.html" %}

{% block title %}Chat ‚Äî Chatbot RAG{% endblock %}

{% block extra_css %}
<style>
    /* ---------------------------------------------------------- */
    /* Layout : sidebar + zone chat, plein √©cran sous la navbar   */
    /* ---------------------------------------------------------- */
    .chat-wrapper {
        height: calc(100vh - 57px);
        display: flex;
        overflow: hidden;
    }

    /* --- Sidebar --- */
    .chat-sidebar {
        width: 260px;
        background: #1e1e2e;
        color: #cdd6f4;
        overflow-y: auto;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
    }
    .sidebar-section {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #313244;
    }
    .sidebar-section:last-child { border-bottom: none; }
    .sidebar-section h6 {
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.8px;
        color: #7f849c;
        margin-bottom: 0.5rem;
    }
    .btn-new-chat {
        background: #313244;
        color: #cdd6f4;
        border: 1px solid #45475a;
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background .2s;
    }
    .btn-new-chat:hover { background: #45475a; }

    .doc-item {
        padding: 0.4rem 0.5rem;
        border-radius: 6px;
        font-size: 0.88rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .doc-item:hover { background: rgba(255,255,255,.08); }
    .doc-item .badge { font-size: 0.65rem; }

    .conv-item {
        padding: 0.45rem 0.5rem;
        border-radius: 6px;
        font-size: 0.88rem;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background .15s;
    }
    .conv-item:hover { background: rgba(255,255,255,.08); }
    .conv-item.active { background: rgba(255,255,255,.14); }
    .conv-item .conv-date { color: #7f849c; font-size: 0.75rem; }

    /* --- Zone chat principale --- */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #fff;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    /* --- Messages --- */
    .msg {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }
    .msg.user  { align-items: flex-end; }
    .msg.assistant { align-items: flex-start; }

    .msg-bubble {
        max-width: 78%;
        padding: 0.7rem 1rem;
        border-radius: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }
    .msg.user .msg-bubble {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border-radius: 14px 4px 14px 14px;
    }
    .msg.assistant .msg-bubble {
        background: #f3f4f6;
        color: #1e293b;
        border-radius: 4px 14px 14px 14px;
    }

    /* --- Sources --- */
    .msg-sources {
        margin-top: 0.35rem;
        font-size: 0.8rem;
        color: #64748b;
    }
    .msg-sources strong { color: #475569; }

    /* --- Coaching suggestions --- */
    .coaching-card {
        background: #e0f2fe;
        border: 1px solid #7dd3fc;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        max-width: 78%;
    }
    .coaching-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    .coaching-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #0c4a6e;
        font-size: 0.95rem;
    }
    .coaching-level-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 12px;
        background: #bae6fd;
        color: #0c4a6e;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .btn-skip-coaching {
        background: transparent;
        border: 1px solid #7dd3fc;
        color: #0369a1;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all .2s;
    }
    .btn-skip-coaching:hover {
        background: #7dd3fc;
        color: #fff;
    }
    .coaching-content {
        color: #0c4a6e;
        font-size: 0.88rem;
        line-height: 1.6;
    }
    .coaching-suggestions {
        margin-top: 0.5rem;
        padding-left: 1.2rem;
    }
    .coaching-suggestions li {
        margin-bottom: 0.3rem;
    }
    .coaching-questions {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: #f0f9ff;
        border-radius: 8px;
        border-left: 3px solid #0ea5e9;
    }
    .coaching-questions strong {
        display: block;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }
    .coaching-questions ul {
        margin: 0;
        padding-left: 1.2rem;
    }

    /* --- Sources expandable --- */
    .sources-accordion {
        margin-top: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
    }
    .sources-header {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #475569;
        transition: background .2s;
    }
    .sources-header:hover {
        background: #f1f5f9;
    }
    .sources-header i {
        transition: transform .2s;
    }
    .sources-header.expanded i {
        transform: rotate(180deg);
    }
    .sources-content {
        padding: 0.75rem;
        border-top: 1px solid #e2e8f0;
        display: none;
        font-size: 0.8rem;
    }
    .sources-content.show {
        display: block;
    }
    .source-item {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .source-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .source-name {
        font-weight: 600;
        color: #334155;
    }
    .source-relevance {
        color: #0ea5e9;
        font-size: 0.75rem;
    }
    .source-excerpt {
        color: #64748b;
        margin-top: 0.25rem;
        font-style: italic;
    }

    /* --- Zone d'entr√©e --- */
    .chat-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        background: #fafafa;
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }
    .chat-input-area textarea {
        flex: 1;
        resize: none;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        padding: 0.65rem 0.85rem;
        font-size: 0.95rem;
        line-height: 1.5;
        min-height: 48px;
        max-height: 140px;
        overflow-y: auto;
    }
    .chat-input-area textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102,126,234,.2);
    }
    .btn-send {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.15rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: opacity .2s;
    }
    .btn-send:hover { opacity: .85; }

    /* --- √âtat vide --- */
    .chat-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        text-align: center;
        padding: 2rem;
    }
    .chat-empty i { font-size: 3rem; margin-bottom: 0.75rem; }

    /* --- Responsive --- */
    @media (max-width: 640px) {
        .chat-sidebar { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">

    <!-- ============================================================ -->
    <!-- Sidebar                                                       -->
    <!-- ============================================================ -->
    <aside class="chat-sidebar">

        <!-- Nouvelle conversation -->
        <div class="sidebar-section">
            <button class="btn-new-chat" onclick="newConversation()">
                <i class="bi bi-plus-lg"></i> Nouvelle conversation
            </button>
        </div>

        <!-- Documents de l'utilisateur -->
        <div class="sidebar-section">
            <h6>Documents</h6>
            {% for doc in documents %}
            <div class="doc-item">
                <i class="bi bi-file-text"></i> {{ doc.filename }}
                <span class="badge badge-{{ doc.status }}">{{ doc.get_status_display }}</span>
            </div>
            {% empty %}
            <p class="text-muted" style="font-size:.85rem;">
                Aucun document.
                <a href="{% url 'documents' %}" class="text-decoration-none" style="color:#a6adc8;">Uploadez ici</a>
            </p>
            {% endfor %}
        </div>

        <!-- Historique des conversations -->
        <div class="sidebar-section" style="flex:1; overflow-y:auto;">
            <h6>Conversations</h6>
            <div id="conversations-list">
                {% for conv in conversations %}
                <div class="conv-item {% if current_conversation and current_conversation.id == conv.id %}active{% endif %}"
                     onclick="loadConversation({{ conv.id }})">
                    {{ conv.title|default:"Nouvelle conversation" }}
                    <span class="conv-date d-block">{{ conv.updated_at|date:"d/m H:i" }}</span>
                </div>
                {% empty %}
                <p class="text-muted" style="font-size:.85rem;">Aucune conversation</p>
                {% endfor %}
            </div>
        </div>
    </aside>

    <!-- ============================================================ -->
    <!-- Zone chat principale                                          -->
    <!-- ============================================================ -->
    <main class="chat-main">

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages">
            {% if chat_messages %}
                {% for msg in chat_messages %}
                <div class="msg {{ msg.role }}">
                    <div class="msg-bubble">{{ msg.content }}</div>
                    {% if msg.role == 'assistant' and msg.sources %}
                    <div class="msg-sources">
                        <strong>Sources :</strong>
                        {% for src in msg.sources %}{{ src.document }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <!-- √âtat vide ‚Äî affich√© quand pas de messages -->
            <div class="chat-empty" id="empty-state">
                <i class="bi bi-chat-dots"></i>
                <p>Comment puis-je vous aider ?</p>
                {% if not documents %}
                <p class="text-warning small">
                    Vous n'avez pas encore de documents.
                    <a href="{% url 'documents' %}">Uploadez un document</a> pour commencer.
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Zone d'entr√©e -->
        <div class="chat-input-area">
            <textarea id="message-input"
                      placeholder="√âcrivez votre message‚Ä¶ (Entr√©e pour envoyer)"
                      rows="1"
                      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
            <button class="btn-send" onclick="sendMessage()" title="Envoyer">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ID de la conversation active (null = nouvelle)
let currentConvId = {% if current_conversation %}{{ current_conversation.id }}{% else %}null{% endif %};

// Mode skip coaching (activ√© par le bouton Skip)
let skipCoaching = false;

// Token CSRF depuis le cookie (n√©cessaire pour les requ√™tes POST AJAX)
function getCsrf() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
}

// ---------------------------------------------------------------
// Envoyer un message
// ---------------------------------------------------------------
async function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    autoResize(input);

    // Cacher l'√©tat vide si pr√©sent
    const empty = document.getElementById('empty-state');
    if (empty) empty.style.display = 'none';

    // Afficher le message utilisateur
    appendMessage('user', text);

    // Indicateur "en cours‚Ä¶"
    const loadingId = appendMessage('assistant', '<em style="color:#94a3b8;">En cours de g√©n√©ration‚Ä¶</em>');

    try {
        const resp = await fetch('{% url "chat_send" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCsrf(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: new URLSearchParams({
                message:         text,
                conversation_id: currentConvId || '',
                skip_coaching:   skipCoaching.toString(),
            }),
        });

        const data = await resp.json();

        if (!resp.ok) {
            replaceMessage(loadingId, 'Erreur : ' + (data.error || 'inconnue'));
            return;
        }

        // Supprimer l'indicateur de chargement
        document.getElementById(loadingId)?.remove();

        // Afficher les suggestions de coaching si disponibles
        if (data.coaching && !skipCoaching) {
            appendCoaching(data.coaching);
        }

        // Afficher la r√©ponse + sources
        appendMessage('assistant', data.response, data.sources);

        // M√©moriser l'ID de conversation
        if (data.conversation_id) currentConvId = data.conversation_id;

    } catch (e) {
        replaceMessage(loadingId, 'Erreur r√©seau. R√©essayez.');
    }
}

// ---------------------------------------------------------------
// Manipulation du DOM ‚Äî messages
// ---------------------------------------------------------------
function appendMessage(role, content, sources) {
    const id = 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
    const div = document.createElement('div');
    div.id  = id;
    div.className = 'msg ' + role;

    // Contenu du message
    let html = '<div class="msg-bubble">' + escapeHtml(content) + '</div>';

    // Ajouter les sources si pr√©sentes
    if (sources && sources.length > 0 && role === 'assistant') {
        html += buildSourcesAccordion(sources);
    }

    div.innerHTML = html;
    document.getElementById('chat-messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
    return id;
}

function appendCoaching(coaching) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = 'coaching-card';

    let html = '<div class="coaching-header">';
    html += '<div class="coaching-title">';
    html += '<i class="bi bi-lightbulb" style="color:#0ea5e9;"></i>';
    html += '<span>üí° Suggestions pour am√©liorer votre question</span>';
    if (coaching.level) {
        html += '<span class="coaching-level-badge">' + coaching.level + '</span>';
    }
    html += '</div>';
    html += '<button class="btn-skip-coaching" onclick="enableSkipCoaching()">Ignorer les suggestions</button>';
    html += '</div>';

    html += '<div class="coaching-content">';

    // Suggestions
    if (coaching.suggestions && coaching.suggestions.length > 0) {
        html += '<ul class="coaching-suggestions">';
        coaching.suggestions.forEach(function(suggestion) {
            html += '<li>' + escapeHtml(suggestion) + '</li>';
        });
        html += '</ul>';
    }

    // Questions de clarification
    if (coaching.clarification_questions && coaching.clarification_questions.length > 0) {
        html += '<div class="coaching-questions">';
        html += '<strong><i class="bi bi-question-circle"></i> Questions de clarification :</strong>';
        html += '<ul>';
        coaching.clarification_questions.forEach(function(question) {
            html += '<li>' + escapeHtml(question) + '</li>';
        });
        html += '</ul>';
        html += '</div>';
    }

    html += '</div>';

    div.innerHTML = html;
    container.appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

function buildSourcesAccordion(sources) {
    const accordionId = 'sources-' + Date.now();
    let html = '<div class="sources-accordion">';
    html += '<div class="sources-header" onclick="toggleSources(\'' + accordionId + '\')">';
    html += '<strong><i class="bi bi-book"></i> ' + sources.length + ' source(s)</strong>';
    html += '<i class="bi bi-chevron-down"></i>';
    html += '</div>';
    html += '<div class="sources-content" id="' + accordionId + '">';

    sources.forEach(function(src) {
        html += '<div class="source-item">';
        html += '<div class="source-name"><i class="bi bi-file-text"></i> ' + escapeHtml(src.document) + '</div>';
        if (src.relevance !== undefined) {
            html += '<div class="source-relevance">Pertinence: ' + (src.relevance * 100).toFixed(0) + '%';
            if (src.chunks_count > 1) {
                html += ' (' + src.chunks_count + ' extraits)';
            }
            html += '</div>';
        }
        if (src.excerpt) {
            html += '<div class="source-excerpt">' + escapeHtml(src.excerpt) + '</div>';
        }
        html += '</div>';
    });

    html += '</div>';
    html += '</div>';
    return html;
}

function toggleSources(id) {
    const content = document.getElementById(id);
    const header = content.previousElementSibling;
    content.classList.toggle('show');
    header.classList.toggle('expanded');
}

function enableSkipCoaching() {
    skipCoaching = true;
    alert('‚úì Suggestions d√©sactiv√©es pour cette conversation');
}

function replaceMessage(id, content, sources) {
    const el = document.getElementById(id);
    if (!el) return;

    // Remplacer le contenu du message
    el.querySelector('.msg-bubble').innerHTML = escapeHtml(content);

    // Ajouter les sources si pr√©sentes
    if (sources && sources.length > 0) {
        const sourcesHtml = buildSourcesAccordion(sources);
        el.innerHTML += sourcesHtml;
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// ---------------------------------------------------------------
// Navigation des conversations
// ---------------------------------------------------------------
function newConversation() {
    currentConvId = null;
    document.getElementById('chat-messages').innerHTML =
        '<div class="chat-empty" id="empty-state">'
      + '<i class="bi bi-chat-dots" style="font-size:3rem;"></i>'
      + '<p>Comment puis-je vous aider ?</p></div>';
}

function loadConversation(convId) {
    window.location.href = '{% url "chat" %}?conversation=' + convId;
}

// ---------------------------------------------------------------
// Auto-resize du textarea
// ---------------------------------------------------------------
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
}
document.getElementById('message-input').addEventListener('input', function() {
    autoResize(this);
});
</script>
{% endblock %}
